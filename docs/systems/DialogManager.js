export default class DialogManager {
  constructor(scene){ this.scene=scene; this.data=scene.cache.json.get('dialogs'); this.state=scene.registry.get('state'); this.dom={ box:document.getElementById('dialog'), text:document.getElementById('dialog-text'), choices:document.getElementById('dialog-choices') }; }
  start(npcId,startId='start'){ const tree=this.data[npcId]; if(!tree) return; this.showNode(tree.nodes[startId], tree, npcId); }
  applyEffects(effects={}, npcId){ const { flags={}, relations={}, items=[] }=effects; Object.entries(flags).forEach(([k,v])=> this.state.flags[k]=v); Object.entries(relations).forEach(([k,delta])=>{ this.state.relations[k]=(this.state.relations[k]||0)+delta; }); items.forEach(it=> this.scene.inventory.add(it)); this.scene.registry.get('save').save(this.state); if(flags && flags.startBattle){ this.close(); this.scene.scene.pause('World'); this.scene.scene.launch('Battle',{ enemy:{ name:'Blacksmith', hp:80, atk:12, def:6, elem:'fire' } }); } }
  showNode(node, tree, npcId){ if(!node){ return this.close(); } this.dom.text.textContent=node.text; this.dom.choices.innerHTML=''; this.dom.box.style.display='block'; (node.choices||[]).forEach(choice=>{ const btn=document.createElement('button'); btn.textContent=choice.label; btn.onclick=()=>{ if(choice.effects) this.applyEffects(choice.effects, npcId); let next=choice.next; if(choice.when){ const ok=Object.entries(choice.when).every(([flag,val])=> this.state.flags[flag]===val); next = ok ? (choice.nextTrue||next) : (choice.nextFalse||next); } this.showNode(tree.nodes[next], tree, npcId); }; this.dom.choices.appendChild(btn); }); if(!node.choices || node.choices.length===0){ const btn=document.createElement('button'); btn.textContent='關閉'; btn.onclick=()=> this.close(); this.dom.choices.appendChild(btn); } }
  close(){ this.dom.box.style.display='none'; }
}