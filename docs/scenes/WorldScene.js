import DialogManager from '../systems/DialogManager.js';
import InventorySystem from '../systems/Inventory.js';
export default class WorldScene extends Phaser.Scene{ constructor(){ super('World'); }
  create(){ const state=this.registry.get('state'); this.map=this.make.tilemap({ key: state.mapKey }); const tiles=this.map.addTilesetImage('tiles','tiles'); this.ground=this.map.createLayer('Ground',tiles,0,0); this.decor=this.map.createLayer('Decor',tiles,0,0); this.walls=this.map.createLayer('Collisions',tiles,0,0); if(this.walls) this.walls.setCollisionByProperty({ collide:true }); this.tileSize=32; this.player=this.add.image(0,0,'player').setOrigin(0).setDepth(10); this.playerTx=state.player.tx; this.playerTy=state.player.ty; this.snapToTile(); this.cameras.main.setBounds(0,0,this.map.widthInPixels,this.map.heightInPixels); this.cameras.main.startFollow(this.player,true); this.cameras.main.setRoundPixels(true); this.bgm=this.sound.add('bgm',{ loop:true, volume:0 }); this.sound.once('unlock',()=>{ this.bgm.play(); }); this.tweens.add({ targets:this.bgm, volume:0.5, duration:1200 }); this.dialog=new DialogManager(this); this.inventory=new InventorySystem(this); this.npcs=[]; const objects=this.map.getObjectLayer('NPCs'); if(objects){ this.npcs=objects.objects.map(o=>({ id:(o.properties||[]).find(p=>p.name==='id')?.value || o.name, tx:Math.floor(o.x/this.tileSize), ty:Math.floor(o.y/this.tileSize) })); } this.cursors=this.input.keyboard.createCursorKeys(); this.keyW=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W); this.keyA=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A); this.keyS=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S); this.keyD=this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D); this.input.keyboard.on('keydown-SPACE', ()=> this.interact()); this.moveCooldown=0; this.moveRepeatDelay=140; const pad=document.querySelector('.pad'); if(pad){ pad.querySelector('.up')?.addEventListener('touchstart', ()=>this.tryStep(0,-1)); pad.querySelector('.down')?.addEventListener('touchstart', ()=>this.tryStep(0,1)); pad.querySelector('.left')?.addEventListener('touchstart', ()=>this.tryStep(-1,0)); pad.querySelector('.right')?.addEventListener('touchstart', ()=>this.tryStep(1,0)); document.getElementById('btn-interact')?.addEventListener('touchstart', ()=>this.interact()); } }
  snapToTile(){ this.player.setPosition(this.playerTx*this.tileSize, this.playerTy*this.tileSize); const state=this.registry.get('state'); state.player.tx=this.playerTx; state.player.ty=this.playerTy; this.registry.get('save').save(state); }
  canWalk(tx,ty){ if(tx<0||ty<0||tx>=this.map.width||ty>=this.map.height) return false; if(!this.walls) return true; const tile=this.walls.getTileAt(tx,ty); return !(tile && tile.properties && tile.properties.collide); }
  tryStep(dx,dy){ if(this.moveCooldown>0) return; const ntx=this.playerTx+dx; const nty=this.playerTy+dy; if(!this.canWalk(ntx,nty)) return; this.playerTx=ntx; this.playerTy=nty; this.snapToTile(); this.moveCooldown=this.moveRepeatDelay; }
  update(time,delta){ if(this.moveCooldown>0) this.moveCooldown-=delta; if(this.cursors.up.isDown||this.keyW.isDown) this.tryStep(0,-1); else if(this.cursors.down.isDown||this.keyS.isDown) this.tryStep(0,1); else if(this.cursors.left.isDown||this.keyA.isDown) this.tryStep(-1,0); else if(this.cursors.right.isDown||this.keyD.isDown) this.tryStep(1,0); }
  interact(){ const dirs=[[0,-1],[0,1],[-1,0],[1,0]]; const px=this.playerTx, py=this.playerTy; const near=this.npcs.find(n=> dirs.some(([dx,dy])=> (n.tx===px+dx && n.ty===py+dy))); if(near){ this.dialog.start(near.id,'start'); } }
}