export default class BattleScene extends Phaser.Scene{ constructor(){ super('Battle'); }
  create(data){ this.state=this.registry.get('state'); this.enemy=data?.enemy || { name:'Slime', hp:60, atk:6, def:2, elem:'water' }; this.player={ ...this.state.player }; this.add.rectangle(0,0,640,384,0x000000).setOrigin(0).setAlpha(0.6); this.add.text(20,20,'戰鬥開始',{ color:'#fff' }); this.log=this.add.text(20,50,'',{ color:'#ccc' }); this.skills=[ { id:'attack', name:'普攻', cd:0, cdMax:0, effect:(att,target)=>{ const dmg=Math.max(1, att.atk - target.def); target.hp-=dmg; return `${att===this.player?'你':this.enemy.name}造成 ${dmg} 傷害`; } }, { id:'fireball', name:'火球', cd:0, cdMax:2, effect:(att,target)=>{ let base=18; if(target.elem==='wood') base*=1.3; target.hp-=base; return `火球術造成 ${base} 法術傷害`; } }, { id:'guard', name:'防禦', cd:0, cdMax:1, effect:(att,target)=>{ att.def += 3; return `提高防禦 +3（1 回合）`; } } ]; this.turn='player'; this.buttons=this.skills.map((sk,i)=>{ const b=this.add.text(20,120+i*28,`${sk.name} [CD:${sk.cd}]`,{ backgroundColor:'#222', color:'#fff', padding:{x:6,y:4} }).setInteractive().on('pointerdown', ()=> this.useSkill(sk)); return b; }); this.updateUI(); }
  updateUI(){ this.log.setText(`你 HP:${this.player.hp} | ${this.enemy.name} HP:${this.enemy.hp}`); this.buttons.forEach((b,i)=>{ const sk=this.skills[i]; b.setText(`${sk.name} [CD:${sk.cd}]`); b.setAlpha(this.turn==='player' && sk.cd===0 ? 1 : 0.6); b.disableInteractive(); if(this.turn==='player' && sk.cd===0) b.setInteractive(); }); }
  useSkill(sk){ if(this.turn!=='player' || sk.cd>0) return; const msg=sk.effect(this.player,this.enemy); this.log.setText(`${msg}
${this.log.text}`); sk.cd=sk.cdMax; if(this.enemy.hp<=0) return this.end('win'); this.endPlayerTurn(); }
  endPlayerTurn(){ this.skills.forEach(s=>{ if(s.cd>0) s.cd--; }); this.turn='enemy'; this.time.delayedCall(500, ()=> this.enemyAct()); this.updateUI(); }
  enemyAct(){ const dmg=Math.max(1, this.enemy.atk - this.player.def); this.player.hp-=dmg; this.log.setText(`${this.enemy.name} 攻擊造成 ${dmg} 傷害
${this.log.text}`); if(this.player.hp<=0) return this.end('lose'); this.turn='player'; this.updateUI(); }
  end(result){ this.add.text(20,220,result==='win'?'勝利！':'你倒下了…',{ color: result==='win'?'#0f0':'#f00' }); this.time.delayedCall(1200, ()=> { this.scene.stop(); this.scene.resume('World'); }); }
}